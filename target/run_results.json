{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.4", "generated_at": "2025-04-16T23:04:23.357581Z", "invocation_id": "1ddd46b1-fad2-465b-a283-3b86deb418e9", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:43.418089Z", "completed_at": "2025-04-16T22:58:43.441761Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:43.463684Z", "completed_at": "2025-04-16T22:58:46.115528Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.701420307159424, "adapter_response": {"_message": "CREATE TABLE (4.1k rows, 496.7 KiB processed)", "code": "CREATE TABLE", "rows_affected": 4073, "bytes_processed": 508659, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "281d9811-6dc0-4967-bf8e-52d4293bd188", "slot_ms": 2894}, "message": "CREATE TABLE (4.1k rows, 496.7 KiB processed)", "failures": null, "unique_id": "model.cs329e_xh.company_data", "compiled": true, "compiled_code": "\nwith stg_company_data as (\nselect * from `silken-fortress-448205-p9`.`cs329e_xh_raw`.`company_data`\n)\nselect * from stg_company_data", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`company_data`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:43.423311Z", "completed_at": "2025-04-16T22:58:43.440990Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:43.442702Z", "completed_at": "2025-04-16T22:58:46.571247Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 3.156139612197876, "adapter_response": {"_message": "CREATE TABLE (61.5k rows, 9.3 MiB processed)", "code": "CREATE TABLE", "rows_affected": 61456, "bytes_processed": 9739922, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "bb027fba-b2ad-4829-bf47-e9d1e8f006b2", "slot_ms": 4245}, "message": "CREATE TABLE (61.5k rows, 9.3 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.employer_details", "compiled": true, "compiled_code": "\nwith stg_employer_details_1 as (\nselect\n    * except (`tax id`,`line by line` ),\n    lpad(cast(cast(`tax id` as int64) as string), 4, '0') as tax_id,\n    CAST(REPLACE(`line by line`, ',', '') AS INT64) AS employer_no\nfrom `silken-fortress-448205-p9`.`cs329e_xh_raw`.`employer_details`\n),\nstg_employer_details as (\n    select\n    employer_no,\n    `fiscal year   ` as fiscal_year,\n    `employer petitioner name` as employer_petitioner_name,\n    tax_id as tax_id,\n    `industry naics code` as naics_code,\n    `petitioner city` as petitioner_city,\n    `petitioner state` as petitioner_state,\n    `petitioner zip code` as petitioner_zip_code,\n    `initial approval` as initial_approval,\n    `initial denial` as initial_denial,\n    `continuing approval` as continuing_approval,\n    `continuing denial` as continuing_denial,\n    _data_source, _load_time\nfrom stg_employer_details_1\n) \nselect * from stg_employer_details", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`employer_details`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:46.126054Z", "completed_at": "2025-04-16T22:58:46.131922Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:46.132628Z", "completed_at": "2025-04-16T22:58:48.660429Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.5365359783172607, "adapter_response": {"_message": "CREATE TABLE (6.0 rows, 2.7 KiB processed)", "code": "CREATE TABLE", "rows_affected": 6, "bytes_processed": 2728, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "9d064987-5d25-46c3-837e-7d703994f052", "slot_ms": 2360}, "message": "CREATE TABLE (6.0 rows, 2.7 KiB processed)", "failures": null, "unique_id": "model.cs329e_xh.h1b_sentiment_analysis", "compiled": true, "compiled_code": "\nwith stg_senti as (\nselect * \nfrom `silken-fortress-448205-p9`.`cs329e_xh_raw`.`h1b_sentiment_analysis`\n)\nselect * from stg_senti", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`h1b_sentiment_analysis`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:46.578267Z", "completed_at": "2025-04-16T22:58:46.583681Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:46.584349Z", "completed_at": "2025-04-16T22:58:48.848317Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.271977424621582, "adapter_response": {"_message": "CREATE TABLE (511.0 rows, 60.2 KiB processed)", "code": "CREATE TABLE", "rows_affected": 511, "bytes_processed": 61671, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "6ff83ffb-8c82-4b8a-a629-8df7a5e2cc06", "slot_ms": 2829}, "message": "CREATE TABLE (511.0 rows, 60.2 KiB processed)", "failures": null, "unique_id": "model.cs329e_xh.lca_appendix", "compiled": true, "compiled_code": "\nwith stg_lca_appendix as (\nselect * from `silken-fortress-448205-p9`.`cs329e_xh_raw`.`lca_appendix`\n)\nselect * from stg_lca_appendix", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`lca_appendix`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:48.855728Z", "completed_at": "2025-04-16T22:58:48.861315Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:48.861996Z", "completed_at": "2025-04-16T22:58:55.880185Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 7.026817321777344, "adapter_response": {"_message": "CREATE TABLE (841.6k rows, 154.3 MiB processed)", "code": "CREATE TABLE", "rows_affected": 841561, "bytes_processed": 161812493, "bytes_billed": 162529280, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "4ff4a38c-35cd-477a-a1d3-44b1ea535cf3", "slot_ms": 15197}, "message": "CREATE TABLE (841.6k rows, 154.3 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.lca_worksites", "compiled": true, "compiled_code": "\nwith stg_lca_worksites as (\nselect * except(worksite_workers, pw_other_year),\n        cast(worksite_workers as int64) as worksite_workers,\n        cast(pw_other_year as int64) as pw_other_year\nfrom `silken-fortress-448205-p9`.`cs329e_xh_raw`.`lca_worksites`\n)\nselect * from stg_lca_worksites", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`lca_worksites`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:48.668151Z", "completed_at": "2025-04-16T22:58:48.674031Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:48.674806Z", "completed_at": "2025-04-16T22:58:58.796359Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 10.130393505096436, "adapter_response": {"_message": "CREATE TABLE (561.0k rows, 485.1 MiB processed)", "code": "CREATE TABLE", "rows_affected": 561037, "bytes_processed": 508633105, "bytes_billed": 509607936, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "0e00fd05-1e8e-4beb-993a-c8a5b6980bc2", "slot_ms": 40894}, "message": "CREATE TABLE (561.0k rows, 485.1 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.lca_disclosure", "compiled": true, "compiled_code": "\nwith s as (\nSELECT\n    * EXCEPT (received_date, decision_date, original_cert_date, total_worker_positions, new_employment, continued_employment, change_previous_employment, new_concurrent_employment, change_employer, amended_petition, worksite_workers, wage_rate_of_pay_from, wage_rate_of_pay_to, prevailing_wage, total_worksite_locations),\n    SAFE_CAST(received_date AS DATETIME) AS received_date,\n    SAFE_CAST(decision_date AS DATETIME) AS decision_date,\n    SAFE_CAST(original_cert_date AS DATETIME) AS original_cert_date,\n    \n    SAFE_CAST(total_worker_positions AS INT64) AS total_worker_positions,\n    SAFE_CAST(new_employment AS INT64) AS new_employment,\n    SAFE_CAST(continued_employment AS INT64) AS continued_employment,\n    SAFE_CAST(change_previous_employment AS INT64) AS change_previous_employment,\n    SAFE_CAST(new_concurrent_employment AS INT64) AS new_concurrent_employment,\n    SAFE_CAST(change_employer AS INT64) AS change_employer,\n    SAFE_CAST(amended_petition AS INT64) AS amended_petition,\n    SAFE_CAST(worksite_workers AS INT64) AS worksite_workers,\n    SAFE_CAST(total_worksite_locations AS INT64) AS total_worksite_locations,\n\n    SAFE_CAST(REGEXP_REPLACE(wage_rate_of_pay_from, r'[\\$,]', '') AS FLOAT64) AS wage_rate_of_pay_from,\n    SAFE_CAST(REGEXP_REPLACE(wage_rate_of_pay_to, r'[\\$,]', '') AS FLOAT64) AS wage_rate_of_pay_to,\n    SAFE_CAST(REGEXP_REPLACE(prevailing_wage, r'[\\$,]', '') AS FLOAT64) AS prevailing_wage\n\nFROM `silken-fortress-448205-p9`.`cs329e_xh_raw`.`lca_disclosure`\n    )\nselect * from s", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`lca_disclosure`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:58.804181Z", "completed_at": "2025-04-16T22:58:58.809614Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:58.810365Z", "completed_at": "2025-04-16T22:59:03.804990Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 5.002941608428955, "adapter_response": {"_message": "CREATE TABLE (350.1k rows, 78.4 MiB processed)", "code": "CREATE TABLE", "rows_affected": 350084, "bytes_processed": 82195255, "bytes_billed": 82837504, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "52858b5f-9ca6-420a-baf7-c84a496d5d6d", "slot_ms": 7512}, "message": "CREATE TABLE (350.1k rows, 78.4 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.single_registrations", "compiled": true, "compiled_code": "\nwith t1 as (\nselect\n    case bcn when '(b)(6)' THEN NULL ELSE bcn END AS bcn,\n    case receipt_number when '(b)(6)' THEN NULL ELSE receipt_number END AS receipt_number,\n    case ben_date_of_birth when '(b)(6)' THEN NULL ELSE ben_date_of_birth END AS ben_date_of_birth,\n    case dol_eta_case_number when '(b)(6)' THEN NULL ELSE dol_eta_case_number END AS dol_eta_case_number,\n    *\nEXCEPT (bcn, receipt_number, ben_date_of_birth, dol_eta_case_number)\nFROM `silken-fortress-448205-p9`.`cs329e_xh_raw`.`single_registrations`\nWHERE bcn != '(b)(3) (b)(6) (b)(7)(c)'\n)\n, t2 as (select * except(bcn, receipt_number, ben_date_of_birth, dol_eta_case_number, t_u_vawa_flag)\nFROM t1)\nselect * from t2", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`single_registrations`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:03.813736Z", "completed_at": "2025-04-16T22:59:03.819748Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:03.820505Z", "completed_at": "2025-04-16T22:59:05.954732Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 2.142956495285034, "adapter_response": {"_message": "CREATE TABLE (20.5k rows, 2.0 MiB processed)", "code": "CREATE TABLE", "rows_affected": 20477, "bytes_processed": 2127957, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "3b9af24d-34a8-45b7-9b06-5b1dd069f1ba", "slot_ms": 3254}, "message": "CREATE TABLE (20.5k rows, 2.0 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.wage_summary", "compiled": true, "compiled_code": "\nwith stg_wage_summary as (\nselect * from `silken-fortress-448205-p9`.`cs329e_xh_raw`.`wage_summary`\n)\nselect * from stg_wage_summary", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`wage_summary`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:58:55.887758Z", "completed_at": "2025-04-16T22:58:55.893417Z"}, {"name": "execute", "started_at": "2025-04-16T22:58:55.894079Z", "completed_at": "2025-04-16T22:59:08.804747Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 12.919039964675903, "adapter_response": {"_message": "CREATE TABLE (237.9k rows, 372.8 MiB processed)", "code": "CREATE TABLE", "rows_affected": 237926, "bytes_processed": 390958407, "bytes_billed": 391118848, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "c0b2d66e-2689-42b6-a3b5-fda7cc8b3774", "slot_ms": 26575}, "message": "CREATE TABLE (237.9k rows, 372.8 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.pw_disclosure", "compiled": true, "compiled_code": "\nwith temp as (\nselect \n    * except(required_experience_months, required_training_months, alt_training_months, alt_experience_months),\n    cast(required_training_months as int64) as required_training_months,\n    cast(required_experience_months as int64) as required_experience_months,\n    cast(alt_training_months as int64) as alt_training_months,\n    cast(alt_experience_months as int64) as alt_experience_months\nfrom `silken-fortress-448205-p9`.`cs329e_xh_raw`.`pw_disclosure`\n),\nstg_pw_disclosure as (\n    select \n    * except(bls_area),\n    SPLIT(bls_area, ',')[SAFE_OFFSET(0)] AS bls_city,\n    IFNULL(SPLIT(bls_area, ',')[SAFE_OFFSET(1)], '') AS bls_state\nfrom temp)\nselect * from stg_pw_disclosure", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`pw_disclosure`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:05.962259Z", "completed_at": "2025-04-16T22:59:05.967270Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:05.967920Z", "completed_at": "2025-04-16T22:59:09.031434Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.0711381435394287, "adapter_response": {"_message": "CREATE TABLE (4.1k rows, 496.7 KiB processed)", "code": "CREATE TABLE", "rows_affected": 4073, "bytes_processed": 508659, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "1cc5c2b9-a78e-4a52-a70a-593c1327eab1", "slot_ms": 3648}, "message": "CREATE TABLE (4.1k rows, 496.7 KiB processed)", "failures": null, "unique_id": "model.cs329e_xh.Company_Data", "compiled": true, "compiled_code": "with int_cd AS\n(\n    SELECT \n    employer_name, \n    count,  \n    employer_url, \n    _data_source, \n    _load_time\nFROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`company_data`\n) select * from int_cd", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`Company_Data`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:08.814888Z", "completed_at": "2025-04-16T22:59:08.822693Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:08.824187Z", "completed_at": "2025-04-16T22:59:12.055215Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 3.2422826290130615, "adapter_response": {"_message": "CREATE TABLE (6.0 rows, 2.7 KiB processed)", "code": "CREATE TABLE", "rows_affected": 6, "bytes_processed": 2728, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "1b29047e-9890-45aa-bbe1-61d1a32ec9aa", "slot_ms": 3150}, "message": "CREATE TABLE (6.0 rows, 2.7 KiB processed)", "failures": null, "unique_id": "model.cs329e_xh.Sentiment_Analysis", "compiled": true, "compiled_code": "with ints as(\n    select * from `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`h1b_sentiment_analysis`\n)\nselect * from ints", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`Sentiment_Analysis`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:09.038844Z", "completed_at": "2025-04-16T22:59:09.044018Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:09.044666Z", "completed_at": "2025-04-16T22:59:12.548640Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.5116922855377197, "adapter_response": {"_message": "CREATE TABLE (511.0 rows, 60.2 KiB processed)", "code": "CREATE TABLE", "rows_affected": 511, "bytes_processed": 61671, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "eb70809f-08f4-426a-aa65-4f800d9436f1", "slot_ms": 2709}, "message": "CREATE TABLE (511.0 rows, 60.2 KiB processed)", "failures": null, "unique_id": "model.cs329e_xh.LCA_Appendix", "compiled": true, "compiled_code": "with int_lca AS (\nSELECT \n    case_number,  \n    appx_a_date_of_degree, \n    appx_a_name_of_institution,  \n    appx_a_no_of_exempt_workers,  \n    appx_a_field_of_study, \n    _data_source, \n    _load_time\nFROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`lca_appendix`\n)\nselect * from int_lca", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Appendix`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:12.555454Z", "completed_at": "2025-04-16T22:59:12.560773Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:12.561403Z", "completed_at": "2025-04-16T22:59:22.798197Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 10.244631052017212, "adapter_response": {"_message": "CREATE TABLE (561.0k rows, 495.2 MiB processed)", "code": "CREATE TABLE", "rows_affected": 561037, "bytes_processed": 519303906, "bytes_billed": 520093696, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "ca599a5a-0a6d-4e19-a880-f3af8dc149d9", "slot_ms": 38135}, "message": "CREATE TABLE (561.0k rows, 495.2 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.LCA_Disclosure", "compiled": true, "compiled_code": "with lca_d as (\n    select * from `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`lca_disclosure`\n)\nselect * from lca_d", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Disclosure`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:12.062468Z", "completed_at": "2025-04-16T22:59:12.067966Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:12.068610Z", "completed_at": "2025-04-16T22:59:23.582562Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 11.522071838378906, "adapter_response": {"_message": "CREATE TABLE (841.6k rows, 154.3 MiB processed)", "code": "CREATE TABLE", "rows_affected": 841561, "bytes_processed": 161812493, "bytes_billed": 162529280, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "881ca021-7156-4408-a3ff-92eea256336c", "slot_ms": 24319}, "message": "CREATE TABLE (841.6k rows, 154.3 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.LCA_Worksites", "compiled": true, "compiled_code": "with lw as(\n    select *\n    from `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`lca_worksites`\n),\nint_lw as(\nSELECT \n    GENERATE_UUID() AS row_id,  -- Assign a unique UUID\n    lw.*  \nFROM lw\n)\nselect * from int_lw", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Worksites`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:23.590473Z", "completed_at": "2025-04-16T22:59:23.595721Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:23.596419Z", "completed_at": "2025-04-16T22:59:26.801951Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 3.213749647140503, "adapter_response": {"_message": "CREATE TABLE (20.5k rows, 2.0 MiB processed)", "code": "CREATE TABLE", "rows_affected": 20451, "bytes_processed": 2127957, "bytes_billed": 10485760, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "744da382-30ec-4411-bda0-cee404b247a3", "slot_ms": 10854}, "message": "CREATE TABLE (20.5k rows, 2.0 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.Wage_Summary", "compiled": true, "compiled_code": "with ws as(\n    select `company name` as `company_name`,\n    `job title` as `job_title`,\n    `min wage` as `min_wage`,\n    `max wage` as `max_wage`,\n    `average wage` as `average_wage`,\n    `job count` as `job_count`,\n    `_data_source`,\n    `_load_time`\n    from `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`wage_summary`\n),\nws2 as(\n   WITH Ranked AS (\n    SELECT *,\n           ROW_NUMBER() OVER (PARTITION BY company_name, job_title ORDER BY _load_time DESC) AS row_num\n    FROM ws\n)\nSELECT * EXCEPT(row_num)\nFROM Ranked\nWHERE row_num = 1\n)\nselect * from ws2", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`Wage_Summary`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:22.805715Z", "completed_at": "2025-04-16T22:59:22.811494Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:22.812173Z", "completed_at": "2025-04-16T22:59:29.668201Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 6.864464521408081, "adapter_response": {"_message": "CREATE TABLE (237.8k rows, 75.7 MiB processed)", "code": "CREATE TABLE", "rows_affected": 237833, "bytes_processed": 79369313, "bytes_billed": 79691776, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "2f77cacc-8bd3-4ddf-9b91-0d0b1b3b51fe", "slot_ms": 13677}, "message": "CREATE TABLE (237.8k rows, 75.7 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.Single_Registration", "compiled": true, "compiled_code": "with sr as(\n    SELECT DISTINCT \n       employer_name, \n       ben_year_of_birth, \n       gender, \n       agent_first_name, \n       agent_last_name, \n       mail_addr, \n       country_of_birth, \n       country_of_nationality, \n       fein, \n       city, \n       state, \n       zip, \n       lottery_year, \n       status_type, \n       ben_multi_reg_ind, \n       rec_date, \n       first_decision, \n       first_decision_date, \n       i129_employer_name, \n       pet_street, \n       pet_city, \n       pet_state, \n       pet_zip, \n       requested_class, \n       basis_for_classification, \n       requested_action, \n       number_of_beneficiaries, \n       ben_sex, \n       ben_country_of_birth, \n       ben_current_class, \n       job_title, \n       worksite_street, \n       worksite_city, \n       worksite_state, \n       worksite_zip, \n       full_time_ind, \n       wage_amt, \n       wage_unit, \n       valid_from, \n       valid_to, \n       num_of_emp_in_us, \n       s1q1a, \n       s1q1b, \n       ben_education_code, \n       ed_level_definition, \n       ben_pfield_of_study, \n       ben_comp_paid, \n       dot_code, \n       naics_code, \n       s3q1, \n       s4q1, \n       _data_source, \n       _load_time\nFROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`single_registrations`)\nselect * from sr where agent_first_name is not null and agent_last_name is not null and employer_name is not null", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`Single_Registration`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:26.809842Z", "completed_at": "2025-04-16T22:59:26.815548Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:26.816247Z", "completed_at": "2025-04-16T22:59:38.613728Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 11.805892705917358, "adapter_response": {"_message": "CREATE TABLE (237.9k rows, 373.1 MiB processed)", "code": "CREATE TABLE", "rows_affected": 237926, "bytes_processed": 391221373, "bytes_billed": 392167424, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "e3efb8c9-75c8-4e75-9527-76f6d820cdc6", "slot_ms": 50752}, "message": "CREATE TABLE (237.9k rows, 373.1 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.PW_Disclosure", "compiled": true, "compiled_code": "with p1 as (\n    select * except(o_net_code_combo, o_net_title_combo),\nif(o_net_code_combo is not null, split(o_net_code_combo,';'),null) as o_net_codes,\nif(o_net_title_combo is not null, split(o_net_title_combo,';'),null) as o_net_titles,\nfrom `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`pw_disclosure`\n),\np2 as (select * except(employer_address_1, employer_address_2, employer_city, employer_state, employer_province, employer_postal_code, employer_country),\ncase\n    when employer_poc_address1 = employer_address_1 then null\n    else employer_address_1\nend as employer_address_1,\n\ncase\n    when employer_poc_address2 = employer_address_2 then null\n    else employer_address_2\nend as employer_address_2,\n\ncase\n    when employer_poc_city = employer_city then null\n    else employer_city\nend as employer_city,\n\ncase\n    when employer_poc_state = employer_state then null\n    else employer_state\nend as employer_state,\n\ncase\n    when employer_poc_province = employer_province then null\n    else employer_province\nend as employer_province,\n\ncase\n    when employer_poc_postal_code = employer_postal_code then null\n    else employer_postal_code\nend as employer_postal_code,\n\ncase\n    when employer_poc_country = employer_country then null\n    else employer_country\nend as employer_country\nfrom p1\n)\nselect * from p2", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`PW_Disclosure`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:38.621362Z", "completed_at": "2025-04-16T22:59:38.627188Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:38.627917Z", "completed_at": "2025-04-16T22:59:41.327954Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.7085795402526855, "adapter_response": {"_message": "CREATE TABLE (12.0 rows, 10.5 MiB processed)", "code": "CREATE TABLE", "rows_affected": 12, "bytes_processed": 11037001, "bytes_billed": 20971520, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "7ef0bb15-a8e9-4f37-b823-af57813fa944", "slot_ms": 6526}, "message": "CREATE TABLE (12.0 rows, 10.5 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.approval_rate_by_month", "compiled": true, "compiled_code": "WITH monthly_windows AS (\n    SELECT \n        EXTRACT (YEAR FROM publication_date) AS year,\n        EXTRACT(MONTH FROM publication_date) AS month,\n        MAX(publication_date) AS latest_date\n    FROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`Sentiment_Analysis`\n    GROUP BY year, month\n),\napproval_rate_monthly AS (\n\n    SELECT \n        EXTRACT(YEAR FROM decision_date) AS year,\n        EXTRACT(MONTH FROM decision_date) AS month,\n        COUNT(CASE WHEN case_status = 'Certified' THEN 1 END) AS approved_count,\n        COUNT(CASE WHEN case_status != 'Certified' THEN 1 END) AS denied_count,\n        COUNT(*) AS total_applications\n    FROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Disclosure`\n    WHERE decision_date IS NOT NULL\n    GROUP BY year, month\n)\nSELECT \n    a.month,\n    m.latest_date,\n    a.approved_count,\n    a.denied_count,\n    a.total_applications,\n    ROUND(100.0 * a.approved_count / a.total_applications, 2) AS approval_rate\nFROM approval_rate_monthly a\nLEFT JOIN monthly_windows m\n    ON a.month = m.month\nORDER BY a.month", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`approval_rate_by_month`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:41.335135Z", "completed_at": "2025-04-16T22:59:41.340886Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:41.341615Z", "completed_at": "2025-04-16T22:59:43.951896Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.6187682151794434, "adapter_response": {"_message": "CREATE TABLE (87.0 rows, 19.6 MiB processed)", "code": "CREATE TABLE", "rows_affected": 87, "bytes_processed": 20545928, "bytes_billed": 20971520, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "af9c62d6-1675-4602-9b20-b146521619d5", "slot_ms": 972}, "message": "CREATE TABLE (87.0 rows, 19.6 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.major_wage_level", "compiled": true, "compiled_code": "WITH salary_by_field AS (\n    SELECT \n        a.appx_a_field_of_study AS field_of_study,\n        l.wage_unit_of_pay,\n        l.wage_rate_of_pay_from AS wage_from,\n        l.wage_rate_of_pay_to AS wage_to\n    FROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Disclosure` l\n    JOIN `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Appendix` a \n        ON l.case_number = a.case_number\n    WHERE a.appx_a_field_of_study IS NOT NULL\n)\n\nSELECT \n    field_of_study,\n    wage_unit_of_pay,\n    COUNT(*) AS num_entries,\n    ROUND(AVG(wage_from), 2) AS avg_wage_from,\n    ROUND(AVG(wage_to), 2) AS avg_wage_to,\n    ROUND(MIN(wage_from), 2) AS min_wage,\n    ROUND(MAX(wage_to), 2) AS max_wage\nFROM salary_by_field\nWHERE wage_from IS NOT NULL AND wage_to IS NOT NULL\nGROUP BY field_of_study, wage_unit_of_pay\nORDER BY field_of_study, wage_unit_of_pay", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`major_wage_level`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:43.959073Z", "completed_at": "2025-04-16T22:59:43.964502Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:43.965195Z", "completed_at": "2025-04-16T22:59:46.402944Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.4460103511810303, "adapter_response": {"_message": "CREATE TABLE (55.0 rows, 41.3 MiB processed)", "code": "CREATE TABLE", "rows_affected": 55, "bytes_processed": 43312923, "bytes_billed": 44040192, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "9c519fb8-f534-43ff-a177-aca424b30d81", "slot_ms": 553}, "message": "CREATE TABLE (55.0 rows, 41.3 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.soc_wage_level", "compiled": true, "compiled_code": "WITH job_salary AS (\n    SELECT \n        l.soc_code,\n        l.soc_title,\n        l.wage_unit_of_pay,\n        l.wage_rate_of_pay_from AS wage_from,\n        l.wage_rate_of_pay_to AS wage_to\n    FROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Disclosure` l\n    JOIN `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Appendix` a \n        ON l.case_number = a.case_number\n    WHERE l.soc_code IS NOT NULL AND l.soc_title IS NOT NULL\n)\n\nSELECT \n    soc_code,\n    soc_title,\n    wage_unit_of_pay,\n    COUNT(*) AS num_entries,\n    ROUND(AVG(wage_from), 2) AS avg_wage_from,\n    ROUND(AVG(wage_to), 2) AS avg_wage_to,\n    ROUND(MIN(wage_from), 2) AS min_wage,\n    ROUND(MAX(wage_to), 2) AS max_wage\nFROM job_salary\nWHERE wage_from IS NOT NULL AND wage_to IS NOT NULL\nGROUP BY soc_code, soc_title, wage_unit_of_pay\nORDER BY avg_wage_from DESC", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`soc_wage_level`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:46.409881Z", "completed_at": "2025-04-16T22:59:46.416011Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:46.416722Z", "completed_at": "2025-04-16T22:59:49.975225Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 3.5671608448028564, "adapter_response": {"_message": "CREATE TABLE (20.1k rows, 50.1 MiB processed)", "code": "CREATE TABLE", "rows_affected": 20110, "bytes_processed": 52504742, "bytes_billed": 53477376, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "eaf1b29c-97c5-40f4-a2ac-e67c6a2dd2db", "slot_ms": 2409}, "message": "CREATE TABLE (20.1k rows, 50.1 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.city_approval_rate", "compiled": true, "compiled_code": "SELECT \n  lw.worksite_city AS city,\n  lw.worksite_state AS state,\n  COUNT(CASE WHEN ld.case_status IN ('Certified', 'Certified - Withdrawn') THEN 1 END) AS total_approved,\n  COUNT(CASE WHEN ld.case_status = 'Denied' THEN 1 END) AS total_denied,\n  COUNT(*) AS total_cases,\n  ROUND(\n    100 * COUNT(CASE WHEN ld.case_status IN ('Certified', 'Certified - Withdrawn') THEN 1 END) \n    / COUNT(*), 2\n  ) AS approval_rate\nFROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Disclosure` ld\nJOIN `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Worksites` lw\nON ld.case_number = lw.case_number\nGROUP BY lw.worksite_city, lw.worksite_state\nORDER BY approval_rate DESC", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`city_approval_rate`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:29.675064Z", "completed_at": "2025-04-16T22:59:29.680654Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:29.681322Z", "completed_at": "2025-04-16T22:59:50.843127Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 21.17000985145569, "adapter_response": {"_message": "CREATE TABLE (90.2k rows, 19.9 MiB processed)", "code": "CREATE TABLE", "rows_affected": 90189, "bytes_processed": 20830557, "bytes_billed": 20971520, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "6df3aefe-e5b0-4aa0-8710-66e5ccc04846", "slot_ms": 4492}, "message": "CREATE TABLE (90.2k rows, 19.9 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.temp_emp", "compiled": true, "compiled_code": "with emp_sing as(\n    select\n    employer_name, fein\n    FROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`single_registrations`\n),\nemp_pw as(\n    select\n    employer_legal_business_name, employer_fein as fein\n    FROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`pw_disclosure`\n    WHERE employer_legal_business_name is not null\n),\ndes as (\n    select distinct\n    employer_name,fein\n    FROM emp_sing)\n, dep as(\n    select distinct\n    employer_legal_business_name, replace(fein,\"-\",'') as fein\n    FROM emp_pw),\ncombined as (\n    select employer_name, fein from des\n  union all\n  select  employer_legal_business_name as employer_name, fein from dep\n)\nSELECT\n  ANY_VALUE(employer_name) AS employer_name, fein\nFROM combined\nGROUP BY fein", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`temp_emp`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:49.981933Z", "completed_at": "2025-04-16T22:59:49.987326Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:49.988004Z", "completed_at": "2025-04-16T22:59:53.637527Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 3.6573662757873535, "adapter_response": {"_message": "CREATE TABLE (55.0 rows, 41.5 MiB processed)", "code": "CREATE TABLE", "rows_affected": 55, "bytes_processed": 43535987, "bytes_billed": 44040192, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "b0b6ea25-27aa-4cf8-bf47-d9a6abac8060", "slot_ms": 3023}, "message": "CREATE TABLE (55.0 rows, 41.5 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.state_approval_rate", "compiled": true, "compiled_code": "SELECT \n  lw.worksite_state AS state,\n  COUNT(CASE WHEN ld.case_status IN ('Certified', 'Certified - Withdrawn') THEN 1 END) AS total_approved,\n  COUNT(CASE WHEN ld.case_status = 'Denied' THEN 1 END) AS total_denied,\n  COUNT(*) AS total_cases,\n  ROUND(\n    100 * COUNT(CASE WHEN ld.case_status IN ('Certified', 'Certified - Withdrawn') THEN 1 END) \n    / COUNT(*), 2\n  ) AS approval_rate\nFROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Disclosure` ld\nJOIN `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Worksites` lw\nON ld.case_number = lw.case_number\nGROUP BY lw.worksite_state\nORDER BY approval_rate DESC", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`state_approval_rate`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:50.851207Z", "completed_at": "2025-04-16T22:59:50.856773Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:50.857442Z", "completed_at": "2025-04-16T22:59:54.237743Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.388648748397827, "adapter_response": {"_message": "CREATE TABLE (55.0 rows, 42.8 MiB processed)", "code": "CREATE TABLE", "rows_affected": 55, "bytes_processed": 44843092, "bytes_billed": 45088768, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "82697a9f-d6b0-436c-b3d9-9e0de0073ba7", "slot_ms": 2540}, "message": "CREATE TABLE (55.0 rows, 42.8 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.state_wage_level", "compiled": true, "compiled_code": "SELECT \n  lw.worksite_state AS state,\n  ROUND(AVG(ld.prevailing_wage), 2) AS avg_wage,\n  ROUND(MAX(ld.prevailing_wage), 2) AS max_wage,\n  ROUND(MIN(ld.prevailing_wage), 2) AS min_wage,\n  COUNT(ld.case_number) AS total_cases\nFROM `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Disclosure` ld\nJOIN `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`LCA_Worksites` lw\nON ld.case_number = lw.case_number\nWHERE ld.prevailing_wage IS NOT NULL\nAND LOWER(ld.pw_unit_of_pay) != 'hour'  -- Exclude hourly wage records\nGROUP BY lw.worksite_state\nORDER BY avg_wage DESC", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`state_wage_level`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:54.000668Z", "completed_at": "2025-04-16T22:59:54.006299Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:54.007018Z", "completed_at": "2025-04-16T22:59:59.497149Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 5.49848747253418, "adapter_response": {"_message": "CREATE TABLE (589.3k rows, 4.9 MiB processed)", "code": "CREATE TABLE", "rows_affected": 589267, "bytes_processed": 5176771, "bytes_billed": 20971520, "location": "US", "project_id": "silken-fortress-448205-p9", "job_id": "af1d54bb-ac77-48a4-9431-8084a435e0ad", "slot_ms": 16583}, "message": "CREATE TABLE (589.3k rows, 4.9 MiB processed)", "failures": null, "unique_id": "model.cs329e_xh.temp_employer_details", "compiled": true, "compiled_code": "WITH matched as (\n    select\n        t.tax_id, t.employer_petitioner_name, \n        m.employer_name,m.fein\n    from `silken-fortress-448205-p9`.`dbt_cs329e_xh_stg`.`employer_details` as t\n    left join `silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`temp_emp` as m\n    ON SUBSTR(m.fein, -4) = t.tax_id\n)\nselect\n    tax_id, employer_petitioner_name as original_name,\n    employer_name as candidate_company_names,\n    fein as candidate_fein\nfrom matched", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`temp_employer_details`", "batch_results": null}, {"status": "error", "timing": [{"name": "compile", "started_at": "2025-04-16T22:59:59.505082Z", "completed_at": "2025-04-16T22:59:59.538039Z"}, {"name": "execute", "started_at": "2025-04-16T22:59:59.538926Z", "completed_at": "2025-04-16T23:04:23.322732Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 263.8255639076233, "adapter_response": {}, "message": "409 Job failed with message [AttributeError: 'SparkSession' object has no attribute 'read_csv']. Additional details can be found at:\nhttps://console.cloud.google.com/dataproc/batches/us-central1/64ea5d22-8fa7-4c9b-b5f3-c3517135c6f2?project=silken-fortress-448205-p9\ngcloud dataproc batches wait '64ea5d22-8fa7-4c9b-b5f3-c3517135c6f2' --region 'us-central1' --project 'silken-fortress-448205-p9'\nhttps://console.cloud.google.com/storage/browser/dataproc-staging-us-central1-124580477847-4asghflq/google-cloud-dataproc-metainfo/460dc4ce-5137-45d9-a4f4-ae2204a8325b/jobs/srvls-batch-02be139e-5a34-471f-a359-3b5e481944eb/\ngs://dataproc-staging-us-central1-124580477847-4asghflq/google-cloud-dataproc-metainfo/460dc4ce-5137-45d9-a4f4-ae2204a8325b/jobs/srvls-batch-02be139e-5a34-471f-a359-3b5e481944eb/driveroutput.* 10: Job failed with message [AttributeError: 'SparkSession' object has no attribute 'read_csv']. Additional details can be found at:\nhttps://console.cloud.google.com/dataproc/batches/us-central1/64ea5d22-8fa7-4c9b-b5f3-c3517135c6f2?project=silken-fortress-448205-p9\ngcloud dataproc batches wait '64ea5d22-8fa7-4c9b-b5f3-c3517135c6f2' --region 'us-central1' --project 'silken-fortress-448205-p9'\nhttps://console.cloud.google.com/storage/browser/dataproc-staging-us-central1-124580477847-4asghflq/google-cloud-dataproc-metainfo/460dc4ce-5137-45d9-a4f4-ae2204a8325b/jobs/srvls-batch-02be139e-5a34-471f-a359-3b5e481944eb/\ngs://dataproc-staging-us-central1-124580477847-4asghflq/google-cloud-dataproc-metainfo/460dc4ce-5137-45d9-a4f4-ae2204a8325b/jobs/srvls-batch-02be139e-5a34-471f-a359-3b5e481944eb/driveroutput.*", "failures": null, "unique_id": "model.cs329e_xh.matching", "compiled": true, "compiled_code": "import pandas as pd\nimport os\nimport json\nfrom google.oauth2 import service_account\n#import json\n#import vertexai\n#from vertexai.generative_models import GenerativeModel\nservice_account_info = {\n  \"type\": \"service_account\",\n  \"project_id\": \"silken-fortress-448205-p9\",\n  \"private_key_id\": \"71d77d1a2073bafb0db6992cdad7614a88a21bdc\",\n  \"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQClBzwnVW9yrimb\\npB0X8ELIvXkaJfNWlUJM8HB+JvUhPcyKH1/vnTlAm+kJkbvNr4xQBCFdDkJri+2y\\nIEdCCaPN7eUxrL5E5zYE5SXlMqw5eAj7Xlngb2s3CdlBfuM/oN2Rro4AhrKGpLlG\\n8GjxNRUxwFoXulIJ4jxIfuWLyUgTFS6t+2I8BaMtpP31XzV4tKU/mwfLVAwMwrUT\\nuWgVyC+nJico3h0Ymr7YkEMqjnVTmgzupnssRTyCSmnnXwTrwzOig5Z0pRIIVtGD\\nOnpfuTSdPFip/e74BqCoysTXe8HaUfamp6Rbm4o67GgZVzhN2AwNimIA7jnIaLvq\\nkrh+Gp/TAgMBAAECggEADKJwqwxB85Q88EMQzSfiXQ8Qif1002CrCkvwOOBPrSNX\\nmQ2M4UH2w6kMHuTu7XDuu6ONUFwKnsRARv5spjQpu9bmULbKfGj9PEO08oa+I8o6\\nWdBf7ixpl3WkEf0edd0hiYlFKuolGeTboIBAcJMhU8VHwIBNzp7pAZ3hgiG/aGJ7\\nxIOigdLUyNR6D/piKok/EFiuAQx5biZ7OdwdV0+SYo1deiV5urH9/SXE4wxAPlIJ\\nGz21qdicyDmC4zEeVDhHqDU6dLP+UW3TYEDB1VwIRRwxHPh7eQGTiiM9Pmb74U7B\\n2kPDN1mWQT5eq4+nMRl/HeXz4JZ4yGFwbaxgFDHTRQKBgQDYOXqMqG6SdkypEMH8\\new4Ibo8jaXHkcXk5MfHCIzPXxMdvbXlFr31H5ulSzt4D7nIW/eNdSqSSxax4ZI4q\\nzc/QZVpHKR5SUuV5xyL+fAorvwQVEoy7WscXIxE+JLaCpUYWCUHHe6M3VC0vG8eF\\nqDTLa+olP00G/ZC3vB/X8OpztwKBgQDDYs3GBGGW3moEGlesTagp4tcrSl0Xh0qJ\\nQfag84ceZvzH1CRHub4/zuSy1e31vbcN1HRlQeqcrwE5sinVEvm/AGaT/7YLbbME\\naajqhf1fFkTNzOHcHPPLJoevLTXWNzu6MdA3yhD8wqSYBXqJW5iT9GeW6L7MJRBa\\njhKp09UMxQKBgQCJY2xU96jac0SeoEFCVkZCYU2eKJ/vkZJ/HxcITingze4TBTJr\\nbuhhyX0z2rIDOX1Q0p2nZ4hOoj/Gd85FsGR9fAjy8lOL55Rb3oaDwPkNdt/3K8Q0\\nP6gFMYkBPX6iYLW5xsP/JrY8r8XOCw6qBIkXQEiUxjYBXRiZRnXNVg0C3QKBgQC3\\nbYytN/O+RXPWAj0Iv6b+G73RIHEg45xwG4NEOxxAyILLvzeINrKLCNrfocNSjxbJ\\nXwke/rEZA5rs5XwsUzIvxFqI2um29Pe5TtCLy9rAaBGT+6KWmH+v2q5LIPCH+TaT\\naKyHk6Y7BSisp4gQZ/NoA2002bA1yx39RZ/z27EJ2QKBgBVqwuio4R70L6g3bP6u\\n+/R25uFNFJs4xRYa2Vz7smLrcqnhu58CdO+Z3eq6Hg4Y/z9PCXN+3J6yOu+RfkuS\\nKqLAPjAvh25G8WRlKNFnSSggiaWcpJkfNW7VY56qMjWGCjrGWxt0n5OBUKCHYNYO\\n0ZkQ9KkdQESzZ33WkYGKGoN3\\n-----END PRIVATE KEY-----\\n\",\n  \"client_email\": \"auth1-970@silken-fortress-448205-p9.iam.gserviceaccount.com\",\n  \"client_id\": \"106644715728790824750\",\n  \"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\",\n  \"token_uri\": \"https://oauth2.googleapis.com/token\",\n  \"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\",\n  \"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/auth1-970%40silken-fortress-448205-p9.iam.gserviceaccount.com\",\n  \"universe_domain\": \"googleapis.com\"\n}\ncredentials = service_account.Credentials.from_service_account_info(service_account_info)\ndef model(dbt, session):\n    table = dbt.ref(\"temp_employer_details\")\n    '''\n    df = table.filter(table[\"tax_id\"].isNotNull())\n    result = []\n    for tax_id, group in df.groupby('tax_id'):\n        original_names = group['original_name'].dropna().unique().tolist()\n        unique_candidates = group.drop_duplicates(subset=['candidate_company_names', 'candidate_fein'])\n        candidate_name_fein = [\n            {row['candidate_company_names']: row['candidate_fein']}\n            for _, row in unique_candidates.iterrows()\n            if pd.notna(row['candidate_company_names']) and pd.notna(row['candidate_fein'])\n        ]\n\n        result.append({\n            \"tax_id\": tax_id,\n            \"original_names\": original_names,\n            \"candidate_name_fein\": candidate_name_fein\n        })\n\n    json_result = json.dumps(result, indent=4, ensure_ascii=False)\n    region = \"us-central1\"\n    model_name = \"gemini-2.0-flash-001\"\n    vertexai.init(project=project_id, location=region)\n    model = GenerativeModel(model_name)\n    data = json_result\n\n    # Prepare Prompt\n    prompt = \"\"\"Here is a list of company names and candidate company names with FEINs.\n    Match each original name to the most appropriate candidate based on similarity.\n    Return a JSON object per line with the following fields:\n    - tax_id\n    - original_name\n    - matched_candidate_name\n    - matched_fein\n    Return only one match per original_name. If no match is found, return null for matched_candidate_name and matched_fein.\n    Do not return explanations.\n    \"\"\"\n\n    # Set batch size\n    batch_size = 5  \n\n    # Prepare Batches\n    records = []\n    record_counter = 0\n    batches = []\n    for entry in data:\n        tax_id = entry.get(\"tax_id\", \"Unknown\")\n        original_names = entry.get(\"original_names\", [])\n        candidate_name_fein = entry.get(\"candidate_name_fein\", [])\n\n        for original_name in original_names:\n            candidate_str = \"\\n\".join([f\"{list(c.keys())[0]}: {list(c.values())[0]}\" for c in candidate_name_fein])\n            record = f\"tax_id: {tax_id}\\noriginal_name: {original_name}\\ncandidates:\\n{candidate_str}\"\n            records.append(record)\n            record_counter += 1\n\n            if record_counter == batch_size:\n                batches.append(\"\\n---\\n\".join(records))\n                records = []\n                record_counter = 0\n\n    if records:\n        batches.append(\"\\n---\\n\".join(records))\n\n    print(f\"{len(batches)} total batches will be sent to Gemini.\")\n\n    # Function to send batch to Gemini with retry on API limit\n    def send_batch_to_gemini(batch_data):\n        max_retries = 5\n        wait_time = 5  \n\n        for attempt in range(max_retries):\n            try:\n                resp = model.generate_content([batch_data, prompt])\n                resp_text = resp.text.replace(\"```json\", \"\").replace(\"```\", \"\")\n                json_lines = resp_text.strip().split(\"\\n\")\n                results = []\n                for line in json_lines:\n                    if line:\n                        try:\n                            results.append(json.loads(line))\n                        except Exception as e:\n                            print(f\"Error converting line to JSON: {line}, Error: {e}\")\n                return results  \n            except Exception as e:\n                if \"Resource exhausted\" in str(e):  \n                    print(f\"API Limit Exceeded. Waiting {wait_time} seconds before retrying. Attempt {attempt+1} of {max_retries}.\")\n                    time.sleep(wait_time)  \n                    wait_time *= 2  \n                else:\n                    print(f\"API Error: {e}\")\n                    return []  \n\n        print(\"Max retries reached. Skipping batch.\")\n        return []  \n\n    # Process all batches with retry mechanism\n    all_results = []\n    for i, batch in enumerate(batches):\n        print(f\"Processing batch {i + 1} of {len(batches)}.\")\n        batch_results = send_batch_to_gemini(batch)\n        all_results.extend(batch_results)\n        time.sleep(1)  \n\n    # Convert to DataFrame\n    df_final = pd.DataFrame(all_results)\n\n    # Remove duplicates\n    df_final.drop_duplicates(subset=[\"tax_id\", \"original_name\", \"matched_candidate_name\", \"matched_fein\"], inplace=True)\n    matching = df_final\n\n    '''\n    \n    matching = session.read_csv(\"gs://cs329e-h1b-project/matched_results_full.csv\")\n    return matching\n\n\n# This part is user provided model code\n# you will need to copy the next section to run the code\n# COMMAND ----------\n# this part is dbt logic for get ref work, do not modify\n\ndef ref(*args, **kwargs):\n    refs = {\"temp_employer_details\": \"silken-fortress-448205-p9.dbt_cs329e_xh_int.temp_employer_details\"}\n    key = '.'.join(args)\n    version = kwargs.get(\"v\") or kwargs.get(\"version\")\n    if version:\n        key += f\".v{version}\"\n    dbt_load_df_function = kwargs.get(\"dbt_load_df_function\")\n    return dbt_load_df_function(refs[key])\n\n\ndef source(*args, dbt_load_df_function):\n    sources = {}\n    key = '.'.join(args)\n    return dbt_load_df_function(sources[key])\n\n\nconfig_dict = {}\n\n\nclass config:\n    def __init__(self, *args, **kwargs):\n        pass\n\n    @staticmethod\n    def get(key, default=None):\n        return config_dict.get(key, default)\n\nclass this:\n    \"\"\"dbt.this() or dbt.this.identifier\"\"\"\n    database = \"silken-fortress-448205-p9\"\n    schema = \"dbt_cs329e_xh_int\"\n    identifier = \"matching\"\n    \n    def __repr__(self):\n        return 'silken-fortress-448205-p9.dbt_cs329e_xh_int.matching'\n\n\nclass dbtObj:\n    def __init__(self, load_df_function) -> None:\n        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)\n        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)\n        self.config = config\n        self.this = this()\n        self.is_incremental = False\n\n# COMMAND ----------\n\n\n", "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`matching`", "batch_results": null}, {"status": "skipped", "timing": [], "thread_id": "Thread-2 (worker)", "execution_time": 0, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.cs329e_xh.Employer_Detail", "compiled": false, "compiled_code": null, "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_int`.`Employer_Detail`", "batch_results": null}, {"status": "skipped", "timing": [], "thread_id": "Thread-1 (worker)", "execution_time": 0, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.cs329e_xh.company_approval_rate", "compiled": false, "compiled_code": null, "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`company_approval_rate`", "batch_results": null}, {"status": "skipped", "timing": [], "thread_id": "Thread-2 (worker)", "execution_time": 0, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.cs329e_xh.company_wage_level", "compiled": false, "compiled_code": null, "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`company_wage_level`", "batch_results": null}, {"status": "skipped", "timing": [], "thread_id": "Thread-1 (worker)", "execution_time": 0, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.cs329e_xh.industry_approval_rate", "compiled": false, "compiled_code": null, "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`industry_approval_rate`", "batch_results": null}, {"status": "skipped", "timing": [], "thread_id": "Thread-2 (worker)", "execution_time": 0, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.cs329e_xh.wage_level_by_industry", "compiled": false, "compiled_code": null, "relation_name": "`silken-fortress-448205-p9`.`dbt_cs329e_xh_mrt`.`wage_level_by_industry`", "batch_results": null}], "elapsed_time": 340.6198148727417, "args": {"send_anonymous_usage_stats": true, "populate_cache": true, "which": "run", "partial_parse": true, "introspect": true, "partial_parse_file_diff": true, "require_yaml_configuration_for_mf_time_spines": false, "invocation_command": "dbt run", "require_explicit_package_overrides_for_builtin_materializations": true, "state_modified_compare_vars": false, "vars": {}, "source_freshness_run_project_hooks": false, "select": [], "skip_nodes_if_on_run_start_fails": false, "exclude": [], "show_resource_report": false, "profiles_dir": "/home/jupyter/.dbt", "write_json": true, "log_format": "default", "require_batched_execution_for_custom_microbatch_strategy": false, "warn_error_options": {"include": [], "exclude": []}, "quiet": false, "empty": false, "log_level_file": "debug", "log_path": "/home/jupyter/cs329e_xh/logs", "print": true, "require_nested_cumulative_type_params": false, "cache_selected_only": false, "static_parser": true, "use_colors": true, "use_colors_file": true, "printer_width": 80, "version_check": true, "project_dir": "/home/jupyter/cs329e_xh", "log_file_max_bytes": 10485760, "indirect_selection": "eager", "log_format_file": "debug", "log_level": "info", "state_modified_compare_more_unrendered_values": false, "favor_state": false, "macro_debugging": false, "strict_mode": false, "require_resource_names_without_spaces": false, "defer": false}}